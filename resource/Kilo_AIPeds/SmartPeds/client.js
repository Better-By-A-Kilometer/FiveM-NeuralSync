"use strict";(()=>{async function ShowKeyboard(){var text="";DisplayOnscreenKeyboard(0,"FMMC_KEY_TIP8","","","","","",100);while(UpdateOnscreenKeyboard()==0){if(UpdateOnscreenKeyboard()==0){DisableAllControlActions(0)}await Delay(0)}if(GetOnscreenKeyboardResult()==null)return text;return GetOnscreenKeyboardResult()}var Delay=ms=>new Promise(res=>setTimeout(res,ms));async function GetClosestPedToPlayer(playerPed,radius){let closestPed=-1;let playerCoords=GetEntityCoords(playerPed,false);const allPeds=GetGamePool("CPed");let closestDistance=-1;for(let ped of allPeds){if(ped==PlayerPedId())continue;let pedCoords=GetEntityCoords(ped,false);let distance=Vdist(playerCoords[0],playerCoords[1],playerCoords[2],pedCoords[0],pedCoords[1],pedCoords[2]);if(closestDistance===-1){closestDistance=distance;closestPed=ped}if(distance<=radius&&(closestPed===0||distance<closestDistance)){closestPed=ped;closestDistance=distance}await Delay(0)}console.log(closestDistance);return closestPed}function ShowNotification(text){SetTextComponentFormat("STRING");AddTextComponentString(text);DisplayHelpTextFromStringLabel(0,false,true,-1)}var resourceName=GetCurrentResourceName();var moduleName="SmartPeds";var ePrefix=`${resourceName}:${moduleName}`;RegisterCommand("talk",async function(source){if(source<0)return;var closestPed=await GetClosestPedToPlayer(PlayerPedId(),5);if(closestPed<0)return ShowNotification("There's no peds nearby to speak to.");var netId=NetworkGetNetworkIdFromEntity(closestPed)||-1;if(!netId||netId<0)return ShowNotification("This ped isn't AI enabled!");emit("attentionPed",netId);const msg=await ShowKeyboard();let response="";var code=GetGameTimer();if(msg!=""){let callback2=function(res){response=res;removeEventListener(`${ePrefix}::sendAIMessage:Code=${code}`,callback2)};var callback=callback2;addNetEventListener(`${ePrefix}::sendAIMessage:Code=${code}`,callback2);emitNet(`${ePrefix}::sendAIMessage`,netId,"Stranger",msg)}},false);var lastPed;async function PlayerSpeaks(){lastPed=await GetClosestPedToPlayer(PlayerPedId(),5);var netId=NetworkGetNetworkIdFromEntity(lastPed);emit("attentionPed",netId)}async function ParseVoiceMessage(text){if(!!lastPed){var netId=NetworkGetNetworkIdFromEntity(lastPed);emit("attentionPed",netId);let response="";var code=GetGameTimer();if(text!=""){let callback2=function(res){response=res;removeEventListener(`${ePrefix}::sendAIMessage:Code=${code}`,callback2)};var callback=callback2;addNetEventListener(`${ePrefix}::sendAIMessage:Code=${code}`,callback2);emitNet(`${ePrefix}::sendAIMessage`,netId,"Stranger",text)}}}on("KiloVoiceRecognition:PlayerSpeaks:Subscribe",PlayerSpeaks);on("KiloVoiceRecognition:VoiceMessage:Subscribe",ParseVoiceMessage);RegisterKeyMapping("talk","Talk to an AI","keyboard","y");})();
